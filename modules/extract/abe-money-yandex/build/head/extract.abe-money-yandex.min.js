var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.9,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","Upgrade-Insecure-Requests":"1","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36"},g_currency={643:"₽",843:"$",978:"€",933:"Br",398:"₸",826:"£",
156:"Ұ",756:"₣",203:"Kč",985:"zł",392:"¥",undefined:""},g_status={anonymous:"Анонимный",light:"Именной",named:"Именной",identified:"Идентифицированный",undefined:""},g_type={Noncontact:"Бесконтактная",Plastic:"Пластиковая",Virtual:"Виртуальная",undefined:""},g_system={MIR:"МИР",Mir:"МИР",undefined:""},baseurl="https://yoomoney.ru/",g_csrf,g_savedData;
function callApi(b,c){if(!g_csrf)throw new AnyBalance.Error("CSRF token not set!");var a=AnyBalance.requestPost(baseurl+b,JSON.stringify(c),addHeaders({Referer:baseurl,"Content-Type":"application/json;charset=UTF-8","x-csrf-token":g_csrf}));if("yooid/signin/api/process/start/standard"==b&&404==AnyBalance.getLastStatusCode())return callApi("yooid/signin/api/process/start",c);b=JSON.parse(a);if("error"===b.status)throw AnyBalance.trace(a),a=b.message||b.errors&&JSON.stringify(b.errors),new AnyBalance.Error(a,
null,/PASSWORD|ACCOUNT/i.test(a));return b}
function login(){var b=AnyBalance.getPreferences();checkEmpty(b.login,"Введите логин!");checkEmpty(b.password,"Введите пароль!");g_savedData||(g_savedData=new SavedData("yoomoney",b.login));g_savedData.restoreCookies();var c=AnyBalance.requestGet(baseurl,g_headers),a=getJsonObject(c,/window.__layoutData__\s*?=/);if(a&&a.user&&a.user.uid)AnyBalance.trace("Already logged in to "+a.user.userName+" ("+b.login+")");else{var d=function(f){if(!f.result)return f.result;if(f.result.nextStepData)return f.result.nextStepData;
if(f.result.nextStep)return f.result};AnyBalance.trace("Logging in anew");c=AnyBalance.requestGet(baseurl+"yooid/signin?origin=Wallet&returnUrl=https%3A%2F%2Fyoomoney.ru%2F",g_headers);g_csrf=getParam(c,/__secretKey__="([^"]*)/);if(!g_csrf)throw AnyBalance.trace(c),new AnyBalance.Error("Не удаётся найти информацию для входа. Сайт изменен?");a=getJsonObject(c,/__data__=/);c=callApi("yooid/signin/api/process/start/standard",{origin:"Wallet",tmxSessionId:"groupib-"+a.staticData.groupIb.sessionId,isAutoStart:!1,
login:b.login});var e=0;do var g=callApiProgress("yooid/signin/api/process/start/standard",{origin:"Wallet",tmxSessionId:"groupib-"+a.staticData.groupIb.sessionId,isAutoStart:!1,login:b.login,processId:c.result.processId,loginType:c.result.loginType});while(!g.result.isLoginSet&&5>++e);if(!g.result.isLoginSet)throw AnyBalance.trace(JSON.stringify(g)),new AnyBalance.Error("Не удалось войти в личный кабинет. Сайт изменен?");for(b=g;b.result&&d(b);)b=processStep(c.result,d(b));c=AnyBalance.requestGet(baseurl)}g_savedData.setCookies();
g_savedData.save();return c}function callApiProgress(b,c){do{a&&AnyBalance.sleep(1E3);var a=callApi(b,c);AnyBalance.trace(b+": "+JSON.stringify(a))}while("progress"===a.status);if((b=a.result&&a.result.status)&&!/^(SUCCESS|ok)$/i.test(b))throw a=a.result.message||a.result.status,new AnyBalance.Error(a,null,/ACCOUNT|PASSWORD/i.test(a));return a}
function processStep(b,c){var a=AnyBalance.getPreferences();AnyBalance.trace("Processing step "+c.nextStep);if("SetPassword"===c.nextStep)a=callApiProgress("yooid/signin/api/password/set",{loginType:b.loginType,processId:b.processId,password:a.password});else if("SetConfirmationCode"===c.nextStep)a=AnyBalance.retrieveCode("Пожалуйста, введите код подтверждения, высланный на номер "+c.maskedRecipient,null,{inputType:"number",time:17E4}),a=callApiProgress("yooid/signin/api/otp/check",{loginType:b.loginType,
processId:b.processId,contextId:b.processId,answer:a});else if("Require2fa"===c.nextStep)a=callApiProgress("yooid/api/2fa/session/start",{authProcessId:c.authProcessId,type:"Sms"}),a=AnyBalance.retrieveCode("Пожалуйста, введите код подтверждения, высланный на номер "+a.result.session.phone,null,{inputType:"number",time:17E4}),a=callApiProgress("yooid/api/2fa/session/check",{authProcessId:c.authProcessId,secret:a}),a=callApiProgress("yooid/signin/api/2fa/check",{loginType:b.loginType,processId:b.processId});
else if("Complete"===c.nextStep)a=callApiProgress("yooid/signin/api/process/complete",{loginType:b.loginType,processId:b.processId});else if("SelectAccount"===c.nextStep){AnyBalance.trace("Multiple accounts found: "+JSON.stringify(c.accounts));c=c.accounts.filter(function(d){return"NotRequired"===d.migrationRequirement});if(!c[0])throw new AnyBalance.Error("Не удалось найти готовый для входа аккаунт!");a=callApiProgress("yooid/signin/api/account/select",{loginType:b.loginType,processId:b.processId,
uid:c[0].uid})}else throw new AnyBalance.Error("Неизвестный шаг");return a}
function loginAndGetBalance(b,c){AnyBalance.setDefaultCharset("UTF-8");b=login();var a=getJsonObject(b,/window.__layoutData__\s*?=/);if(a){AnyBalance.trace("Загружаем из layoutData");getParam(a.user.accountId,c,"number");getParam(a.user.accountId,c,"__tariff");getParam(a.user.userName,c,"userName");getParam(g_status[a.user.accountStatus]||a.user.accountStatus,c,"accountStatus");getParam(a.balance.rub.availableAmount,c,["balance","currency"],null,null,parseBalance);getParam(g_currency[a.balance.rub.currencyCode],
c,["currency","balance"]);a.bonus?getParam(a.bonus.availableAmount,c,"bonus",null,null,parseBalance):(b=AnyBalance.requestGet(baseurl+"loyalty",g_headers),a=getJsonObject(b,/window.__data\s*?=/),getParam(a.bonusBalance,c,"bonus",null,null,parseBalance));try{b=AnyBalance.requestGet(baseurl+"cards",g_headers);var d=getJsonObject(b,/window.__data__\s*?=/).userCards;if(d&&0<d.length){card=d[0];getParam(card.panFragment.panLast4,c,"cardNumber",/\d{4}$/,[/(\d{4})/,"**** $1"]);getParam(g_system[card.paymentSystem]||
card.paymentSystem,c,"paymentSystem");getParam(g_type[card.media]||card.media,c,"cardType");var e=getParam(card.expirationDate,null,null,null,null,parseDateISO);if(e){c.cardDate=e;var g=Math.ceil((e-(new Date).getTime())/86400/1E3);0<=g?c.cardDays=g:(AnyBalance.trace("Дата деактивации уже наступила"),c.cardDays=0)}else AnyBalance.trace("Не удалось получить дату действия карты")}}catch(f){AnyBalance.trace("Ошибка получения информации по картам"+f.message)}}else{AnyBalance.trace("Загружаем по-старинке");
getParam(b,c,"number",/Номер кошелька(?:[^>]*>){2}(\d{10,20})/i,replaceTagsAndSpaces);(d=getElements(b,[/<button/ig,/balance__icon/i])[0])&&(d=replaceAll(d,replaceTagsAndSpaces));AnyBalance.trace("Предположительно баланс где-то здесь: "+d);if(!d||/\*{3}/.test(d))if(AnyBalance.trace("Сумма спрятана. Будем пытаться найти..."),d=getParam(b,null,null,/<div[^>]+class="[^>]*\bbalance\b[^>]+data-bem=[']([^']*)/i,replaceHtmlEntities,getJson),AnyBalance.trace("Получаем баланс из "+JSON.stringify(d)),d&&d.balance&&
d.balance.amount&&isset(d.balance.amount.sum))getParam(d.balance.amount.sum,c,"balance",null,null,parseBalance);else throw AnyBalance.trace(b),new AnyBalance.Error("Не удаётся найти спрятанный баланс! Сайт изменен?");else getParam(d,c,"balance",null,replaceTagsAndSpaces,parseBalance);getParam(b,c,"bonus",/Скол`ько у вас баллов[\s\S]*?<div[^>]+balance__item[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance)}}
function processHistory(b){if(AnyBalance.isAvailable("transactions")){var c=0;b.transactions=[];for(var a=1;10>=a;a++){var d=AnyBalance.requestGet(baseurl+"ajax/history/partly?ncrnd=72010&history_shortcut=history_all&start-record="+c+"&record-count=100",addHeaders({"X-Requested-With":"XMLHttpRequest"}));c+=100;d=getJson(d);AnyBalance.trace("Найдено транзакций: "+d.history.length);for(var e=0;e<d.history.length;++e){var g={};getParam((2==d.history[e].type?"-":"")+d.history[e].sum,g,"transactions.sum",
null,replaceTagsAndSpaces,parseBalance);getParam(d.history[e].name,g,"transactions.name",null,replaceTagsAndSpaces);getParam(d.history[e].date,g,"transactions.time",null,replaceTagsAndSpaces,parseDateISO);b.transactions.push(g)}if(!d.hasMore){AnyBalance.trace("Транзакций больше нет...");break}}}}function getCombinedHistory(){return[]}
function combineHistory(b,c){for(var a=0,d=0;a<c.items.length;++a){var e=c.items[a],g=parseDateISOSilent(e.date);if(/за пятый|в категории месяца/i.test(e.name))var f="card";else/за плат[её]ж в интернете/i.test(e.name)?f="internet":!1===e.isIncoming?f="balls":(AnyBalance.trace("Тип начисления баллов неизвестен: "+e.name+"\n"+JSON.stringify(e)),f="unknown");if("balls"!==f){for(;d<b.history.length&&parseDateISOSilent(b.history[d].date)>g;++d);if(d>=b.history.length)break;for(var k=d;k<b.history.length;++k){var h=
b.history[d],l=parseDateISOSilent(h.date);if(3E5<g-l)break;if("card"!==f||h.flags["is-meta-ycard-operation"])if("internet"!==f||h.flags["is-out-shop"]){h.__balls=e;d=k+1;break}}h.__balls||AnyBalance.trace("Не удалось найти транзакцию для баллов "+JSON.stringify(e))}}AnyBalance.trace(a+"/"+c.items.length+" баллов поставлены в соответствие транзакциям")};
