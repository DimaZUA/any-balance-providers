var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.31 (KHTML, like Gecko) Chrome/26.0.1410.64 Safari/537.31"},g_currencys={"руб":"р",RUR:"р","тенге":"₸",undefined:""};
function getBlock(b,a,c){b=getBlockInner(b,a,c);if("string"==typeof b){a=c.replace(/^\^/,"");var f=a!=c;/bonusesForm/i.test(c)&&(a=getParam(a,null,null,/([^\s]+)/i));return extractFromUpdate(b,a,f)}return b}
function getBlockInner(b,a,c){var f=c.replace(/^\^/,""),e=f!=c,g=a;isArray(a)&&(g=a[1],a=a[0]);a=getParam(a,null,null,new RegExp("PrimeFaces\\.\\w+\\s*\\(\\s*\\{[^}]*u:\\s*'"+(e?"":"[^']*")+f));if(!a)return AnyBalance.trace("Блок "+c+" не найден!"),"";f=getParam(a,null,null,/f:\s*'([^']*)/,replaceSlashes);if(!f)return AnyBalance.trace("Не найден ID формы для блока "+c+"!"),"";g=getParam(g,null,null,new RegExp('<form[^>]+name="'+f+'"[\\s\\S]*?</form>',"i"));if(!g)return AnyBalance.trace("Не найдена форма "+
f+" для блока "+c+"!"),"";c=createFormParams(g);g=getParam(a,null,null,/s:\s*'([^']*)/,replaceSlashes);a=getParam(a,null,null,/u:\s*'([^']*)/,replaceSlashes);c["javax.faces.partial.ajax"]=!0;c["javax.faces.source"]=g;c["javax.faces.partial.execute"]="@all";c["javax.faces.partial.render"]=a;c[g]=g;return b?a=AnyBalance.requestPost(b,c,addHeaders({Referer:b,"Faces-Request":"partial/ajax","X-Requested-With":"XMLHttpRequest"})):c}
function extractFromUpdate(b,a,c){c=getParam(b,null,null,new RegExp('<update[^>]*id="'+(c?"":'[^"]*')+a+'"[^>]*>\\s*<!\\[CDATA\\[([\\s\\S]*?)\\]\\]></update>',"i"));return c?c:(AnyBalance.trace("Неверный ответ для блока "+a+": "+b),"")}
function refreshBalance(b,a,c){var f=getParam(a,null,null,/PrimeFaces\.\w+\s*[^}]*(?:header|home)Balance/i);if(!f)return AnyBalance.trace("Блок headerBalance не найден!"),"";var e=getParam(a,null,null,/<form[^>]*action="(?:[^>]*>){3}\s*loadingBalance[\s\S]*?<\/form>/i);if(!e)return AnyBalance.trace("Не найдена форма для блока (?:header|home)Balance!"),"";c=getParam(e,null,null,/s:\s*["']([^"']+)/i,replaceSlashes);f=getParam(f,null,null,/(?:u|block):\s*["']([^"']+)/i,replaceSlashes);a=getParam(a,null,
null,/<input[^>]+name="javax.faces.ViewState"[^>]*value="([^"]+)/i,replaceHtmlEntities);e=createFormParams(e);e["javax.faces.partial.ajax"]=!0;e["javax.faces.source"]=c;e["javax.faces.partial.execute"]="@all";e["javax.faces.partial.render"]=f;e[c]=c;e["javax.faces.ViewState"]=a;a=AnyBalance.requestPost(b,e,addHeaders({Referer:b,"Faces-Request":"partial/ajax","X-Requested-With":"XMLHttpRequest"}));return extractFromUpdate(a,f,!0)}
function getBonusesBlock(b,a,c,f,e){var g=a;isArray(a)&&(g=a[1],a=a[0]);var h=new RegExp("(?:loadingbonusesloaderDetails|loadingAccumulators)\\s*=\\s*function\\(\\) \\{PrimeFaces\\.\\w+\\s*\\(\\s*\\{[^}]*u:\\s*'"+(f?"":"[^']*")+c);h=getParam(a,null,null,h);if(!h)return AnyBalance.trace("Блок "+c+" не найден!"),"";a=getParam(h,null,null,/f:\s*'([^']*)/,replaceSlashes);if(!a)return AnyBalance.trace("Не найден ID формы для блока "+c+"!"),"";g=getParam(g,null,null,new RegExp('<form[^>]+name="'+a+'"[\\s\\S]*?</form>',
"i"));if(!g)return AnyBalance.trace("Не найдена форма "+a+" для блока "+c+"!"),"";g=createFormParams(g);a=getParam(h,null,null,/s:\s*'([^']*)/,replaceSlashes);h=getParam(h,null,null,/u:\s*'([^']*)/,replaceSlashes);g["javax.faces.partial.ajax"]=!0;g["javax.faces.source"]=a;g["javax.faces.partial.execute"]="@all";g["javax.faces.partial.render"]=h;g[a]=a;if(e)return g;a=AnyBalance.requestPost(b,g,addHeaders({Referer:b,"Faces-Request":"partial/ajax","X-Requested-With":"XMLHttpRequest"}));/bonusesForm/i.test(c)&&
(c=getParam(c,null,null,/([^\s]+)/i));h=new RegExp('<update[^>]*id="'+(f?"":'[^"]*')+c+'"[^>]*>\\s*<!\\[CDATA\\[([\\s\\S]*?)\\]\\]></update>',"i");h=getParam(a,null,null,h);return h?h:(AnyBalance.trace("Неверный ответ для блока "+c+": "+a),"")}function myParseCurrency(b){var a=b.replace(/\s+/g,"").replace(/[\-\d\.,]+/g,"");a=g_currencys[a]||a;AnyBalance.trace("Parsing currency ("+a+") from: "+b);return a}
function checkCorrectNumberLogin(b,a){var c=AnyBalance.getPreferences();a=getParam(a,null,null,[/"sso-number"[^>]*>([^<]*)/i,/<h1[^>]+class="phone-number"[^>]*>([\s\S]*?)<\/h1>/i],[/\D/g,""]);if(!a)throw new AnyBalance.Error("Не удалось выяснить на какой номер мы залогинились, сайт изменен?");AnyBalance.trace("Судя по всему, мы уже залогинены на номер "+a);c=c.phone||c.login;if(!endsWith(a,c))return AnyBalance.trace("Залогинены на неправильный номер "+a+" т.к. в настройках указано, что номер должен заканчиваться на "+
c+". Надо перелогиниться."),AnyBalance.requestGet(b+"c/logout.xhtml",addHeaders({Referer:AnyBalance.getLastUrl()})),AnyBalance.requestGet(b+"oam_logout_success",g_headers),!1;AnyBalance.trace("Залогинены на правильный номер "+a);return!0}
function loginProc(b,a,c){var f=AnyBalance.getPreferences();try{var e=AnyBalance.requestPost(b+(a||"login.xhtml"),c,addHeaders({Referer:b+"login.xhtml"}))}catch(g){if(f.__debug)e="b2b"==f.__debug?AnyBalance.requestGet(b+"b/index.xhtml"):AnyBalance.requestGet(b+"c/"+f.__debug+"/index.html");else throw g;}return e}function isMultinumbersCabinet(b){return 1<sumParam(b,null,null,/selectAccount\('\d+'\);/ig).length}
function canUseMobileApp(b){return(!b.phone||b.phone==b.login)&&/^\d{10}$/.test(b.login)}function login(b){AnyBalance.setDefaultCharset("utf-8");return AnyBalance.getPreferences().password?loginWithPassword(b):loginWithoutPassword(b)}function isLoggedIn(b){return/logOutLink|Загрузка баланса\.\.\.|b\/logout.xhtml/i.test(b)}
function getLKType(b){if(/b\/logout.xhtml/i.test(b))return __setLoginSuccessful(),{type:"B2B",html:b};if(!isLoggedIn(b)){var a=getParam(b,null,null,[/<div[^>]+class="error-page[\s|"][^>]*>([\s\S]*?)<\/div>/i,/<span[^>]+class="ui-messages-error-summary"[^>]*>([\s\S]*?)<\/span>/i],replaceTagsAndSpaces);if(a)throw new AnyBalance.Error(a,null,/Неправильные логин и\s*(?:\(или\)\s*)?пароль|Пользователь не найден/i.test(a));if(400<AnyBalance.getLastStatusCode())throw AnyBalance.trace("Beeline returned: "+
AnyBalance.getLastStatusString()),new AnyBalance.Error("Личный кабинет Билайн временно не работает. Пожалуйста, попробуйте позднее.");if(a=getParam(b,null,null,/<h1>\s*(Личный кабинет временно недоступен\s*<\/h1>[\s\S]*?)<\//i,replaceTagsAndSpaces))throw new AnyBalance.Error(a);AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось зайти в личный кабинет. Сайт изменен?");}__setLoginSuccessful();return/postpaid/i.test(b)?{type:"POSTPAID",html:b}:{type:"PREPAID",html:b}}
function doLogin(b,a,c){var f=AnyBalance.requestGet(b,g_headers),e=getParam(f,null,null,/<form[^>]+name="loginFormB2C:loginForm"[^>]*>[\s\S]*?<\/form>/i);isLoggedIn(f)&&(AnyBalance.trace("Похоже, что мы запустились через мобильный интернет."),checkCorrectNumberLogin(b,f)||(f=AnyBalance.requestGet(b+"login.xhtml",g_headers),e=getParam(f,null,null,/<form[^>]+name="loginFormB2C:loginForm"[^>]*>[\s\S]*?<\/form>/i)));if(e){AnyBalance.trace("Похоже, что форма авторизации присутствует.");var g=createFormParams(e);
g["loginFormB2C:loginForm:login"]=a;g["loginFormB2C:loginForm:password"]=c;g["loginFormB2C:loginForm:passwordVisible"]=c;g["loginFormB2C:loginForm:loginButton"]="";a=getParam(e,null,null,/<form[^>]+action="\/([^"]*)/i,replaceHtmlEntities);for(c=1;6>c;c++)if(f=loginProc(b,a,g),/Вход в личный кабинет/i.test(f)&&!/<span[^>]+class="ui-messages-error-summary"/i.test(f))AnyBalance.trace("Войти не удалось, сайт не сообщает ни о каких ошибках, попытка №"+c);else{AnyBalance.trace("Выполнили "+c+" попыток входа..");
break}}else if(!isLoggedIn(f)){AnyBalance.trace("Похоже, форма авторизации отсутствует.");if(400<AnyBalance.getLastStatusCode())throw AnyBalance.trace("Beeline returned: "+AnyBalance.getLastStatusString()),new AnyBalance.Error("Личный кабинет Билайн временно не работает. Пожалуйста, попробуйте позднее.");AnyBalance.trace(f);throw new AnyBalance.Error("Не удаётся найти форму входа. Сайт изменен?");}return f}
function loginWithPassword(b){var a=AnyBalance.getPreferences();checkEmpty(a.login,"Введите логин!");checkEmpty(a.password,"Введите пароль!");a=doLogin(b,a.login,a.password);/Ваш пароль временный\.\s*Необходимо изменить его на постоянный/i.test(a)&&(AnyBalance.trace("Билайн считает наш пароль временным, но это может быть и не так, попробуем еще раз войти..."),a=AnyBalance.requestPost(b+(action||"login.html"),params,addHeaders({Referer:b+"login.html"})));if(/<form[^>]+name="(?:chPassForm)"|Ваш пароль временный\.\s*Необходимо изменить его на постоянный/i.test(a))throw new AnyBalance.Error("Вы зашли по временному паролю, требуется сменить пароль. Для этого войдите в ваш кабинет "+
b+" через браузер и смените там пароль. Новый пароль введите в настройки данного провайдера.",null,!0);if(/<form[^>]+action="\/(?:changePass|changePassB2C).html"/i.test(a))throw new AnyBalance.Error("Билайн требует сменить пароль. Зайдите в кабинет "+b+" через браузер и поменяйте пароль на постоянный.",null,!0);return getLKType(a)}
function proceedWithSite(b,a,c,f){getParam(a,f,"type");switch(a){case "B2B":fetchB2B(b,c,f);break;case "PREPAID":fetchPre(b,c,f);break;case "POSTPAID":fetchPost(b,c,f);break;default:throw new AnyBalance.Error("Неизвестный тип кабинета: "+a);}}function parseBalanceNegative(b){b=parseBalance(b);if(isset(b))return-b}
function fetchB2B(b,a,c){var f=AnyBalance.getPreferences();AnyBalance.trace("Мы в кабинете для юр. лиц...");getParam(a,c,"fio",/"user-name"([^>]*>){2}/i,replaceTagsAndSpaces,capitalFirstLetters);if(AnyBalance.isAvailable("balance","agreement","currency","overpay")){var e=sumParam(a,null,null,/b\/info\/contractDetail\.xhtml\?objId=\d+[^>]*>\d{5,10}/ig);if(!e||1>e.length)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти ни одного договора, сайт изменен, либо проблемы на сайте.");AnyBalance.trace("Договоров: "+
e.length);e=e[0];a=getParam(e,null,null,/>(\d+)/);getParam(e,null,null,/b\/info\/contractDetail\.xhtml\?objId=(\d+)/i);e=getParam(e,null,null,/b\/info\/contractDetail\.xhtml\?objId=\d+/i);AnyBalance.trace("Получим информацию по договору: "+a);a=AnyBalance.requestGet(b+e,g_headers);getParam(a,c,"agreement",/Договор №([\s\d]+)/i,replaceTagsAndSpaces);getParam(a,c,"balance",/class="balance"[^>]*>([\s\S]*?)<\/div>/i,[replaceTagsAndSpaces,/Сумма неоплаченных счетов[^\d]+/i,"-"],parseBalance);getParam(a,
c,"overpay",/class="[^>]*balance"[^>]*>([\s\S]*?)<\/div>/i,[replaceTagsAndSpaces,/Сумма неоплаченных счетов[^\d]+/i,"-"],parseBalance);getParam(a,c,["currency","balance"],/class="balance"[^>]*>([\s\S]*?)<\/div>/i,[replaceTagsAndSpaces,/все счета оплачены/,"",/[.,]/g,""],myParseCurrency)}a=AnyBalance.requestGet(b+"b/info/abonents/catalog.xhtml",g_headers);f.phone&&(a=AnyBalance.requestGet(b+"b/search/result.xhtml?q="+encodeURIComponent(f.phone),{Referer:b+"b/index.xhtml"}));a=getParam(a,/\/([^"]*subscriberDetail.xhtml[^"]*)/i,
replaceHtmlEntities);checkEmpty(a,"Не удалось найти "+(f.phone?"номер с последними цифрами "+f.phone:"ни одного номера!"),!0);a=AnyBalance.requestGet(b+a,{Referer:AnyBalance.getLastUrl()});c.info||(c.info={});getParam(a,c.info,"info.phone",/subheader\s*"([^>]*>){3}/i,replaceTagsAndSpaces);getParam(a,c,"tariff",/Тариф:([^>]*>){5}/i,replaceTagsAndSpaces);isAvailable("balance")&&getParam(a,null,null,/<form id="reportDetailUnbilledButtonsForm"[\s\S]*?<\/form>/i);b=sumParam(a,null,null,/class="accumulator"[^>]*>([\s\S]*?)<\/div/ig);
AnyBalance.trace("Найдено бонусов и пакетов: "+b.length);c.remainders||(c.remainders={});for(f=0;f<b.length;f++){e=b[f];var g=getParam(e,/([^<]*)</i),h=getParam(e,/израсходовано[^>]*>([\s\d.,]+мин)/i,replaceTagsAndSpaces,parseMinutes),l=getParam(e,/из доступных[^>]*>([\s\d.,]+мин)/i,replaceTagsAndSpaces,parseMinutes),k=getParam(e,/израсходовано[^>]*>([\s\d.,]+штук)/i,replaceTagsAndSpaces,parseBalance),m=getParam(e,/из доступных[^>]*>([\s\d.,]+штук)/i,replaceTagsAndSpaces,parseBalance);/Ноль на Билайн/i.test(g)&&
isset(h)&&isset(l)?sumParam(l-h,c.remainders,"remainders.min_bi",null,null,null,aggregate_sum):isset(h)&&isset(l)?isset(c.remainders.min_left_1)||isset(c.remainders.min_left_2)?isset(c.remainders.min_left_1)&&!isset(c.remainders.min_left_2)?sumParam(l-h,c.remainders,"remainders.min_left_2",null,null,null,aggregate_sum):sumParam(l-h,c.remainders,"remainders.min_local",null,null,null,aggregate_sum):sumParam(l-h,c.remainders,"remainders.min_left_1",null,null,null,aggregate_sum):isset(k)&&isset(m)?sumParam(m-
k,c.remainders,"remainders.sms_left",null,null,null,aggregate_sum):AnyBalance.trace("Неизвестная опция, либо неизвестные единицы измерений: "+e)}0==b.length&&getBonuses(a,c)}
function processInfo_basic(b,a,c){getParam(a,c.info,"info.more3",/Вы с нами больше трёх лет!/i,null,function(f){return!!f});getParam(a,c.info,"info.phone",/<h1[^>]+class="phone-number"[^>]*>([\s\S]*?)<\/h1>/i,replaceTagsAndSpaces);getParam(a,c.info,"info.region",/<div[^>]+region[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces)}
function processInfoPost_basic(b,a,c){if(AnyBalance.isAvailable("info.fio","info.email","info.phone")){c.info||(c.info={});getParam(a,c.info,"info.fio",/<div[^>]+class="ban-param name"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);if(AnyBalance.isAvailable("info.email")){var f=a;/<div[^>]+class="email-fixed-width"[^>]*>/i.test(a)||(f=getBlock(b+"c/post/index.xhtml",a,"benAddressLoaderDetails"));getParam(f,c.info,"info.email",/<div[^>]+class="email-fixed-width"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces)}processInfo_basic(b,
a,c)}}
function switchNumberPost(b,a){var c=AnyBalance.getPreferences();if(!/^\d{4,10}$/.test(c.phone))throw new AnyBalance.Error("Введите от 4 до 10 последних цифр номера дополнительного телефона без пробелов и разделителей или не вводите ничего, чтобы получить информацию по первому номеру!",null,!0);var f=1,e=c.phone.replace(/(\d)/g,"$1[\\s\\-()]*");e=new RegExp("(?:<a[^>]*>\\s*)?<span[^>]*>\\+7[0-9\\s\\-()]*"+e+"</span>","i");e=getParam(a,null,null,e);if(!isset(e)&&(f=2,e=new RegExp('div[^>]*(?:>)[^>]*onclick="\\s*selectAccount\\([\'\\"]\\d*'+c.phone+
"['\\\"][^>]*","i"),e=getParam(a,null,null,e),!e))throw new AnyBalance.Error("Не найден присоединенный к договору номер телефона, оканчивающийся на "+c.phone);c=getParam(e,null,null,/selectAccount\('([^']*)/,replaceSlashes);isset(c)||(c=getParam(e,null,null,null,replaceTagsAndSpaces));checkEmpty(c,"Не удалось найти номер на который необходимо переключиться, сайт изменен?",!0);if(/sso-account-current|class="selected"/i.test(e))AnyBalance.trace("Дополнительный номер "+c+" уже выбран");else{AnyBalance.trace("Переключаемся на номер "+
c);if(1==f)var g=getParam(e,null,null,/addSubmitParam\('([^']*)/,replaceSlashes),h=getParam(e,null,null,/addSubmitParam\('[^']*',(\{.*?\})\)/,null,getJsonEval);else{g=getParam(a,null,null,/changeUser\s*=[^<]*?(?:f|formId):["']([^"']+)/i,replaceSlashes);var l=getParam(a,null,null,/changeUser\s*=[^<]*?(?:s|source):["']([^"']+)/i,replaceSlashes)}a=getParam(a,null,null,new RegExp('<form[^>]+id="'+g+'"[^>]*>([\\s\\S]*?)</form>',"i"));if(!a)throw AnyBalance.trace(e),new AnyBalance.Error("Дополнительный номер "+
c+" найден, но переключиться на него не удалось. Возможны изменения в личном кабинете...");1==f?(f=createFormParams(a),h=joinObjects(f,h)):(f=createFormParams(a),h=joinObjects(f,{"javax.faces.partial.ajax":"true","javax.faces.source":l,"javax.faces.partial.execute":"@all",newSsoLogin:c}),h[l]=l);try{AnyBalance.requestPost(b+"c/post/index.xhtml",h,addHeaders({Referer:b+"c/post/index.xhtml"}))}catch(k){}a=AnyBalance.requestGet(b+"c",g_headers)}return a}
function fetchPost(b,a,c){var f=AnyBalance.getPreferences();AnyBalance.trace("Мы в постоплатном кабинете");var e=/onclick\s*=\s*"\s*selectAccount\('\d{10}|<span[^>]+class="selected"[^>]*>/i.test(a),g=[replaceTagsAndSpaces,/информация[^<]*недоступна|недоступна|(?:баланс)?\s*временно недоступен/ig,""];getParam(a,c,"agreement",/<h2[^>]*>\s*Договор №([\s\S]*?)<\/h2>/i,replaceTagsAndSpaces);getParam(a,c,"tariff",/<h2[^>]*>(?:[\s\S](?!<\/h2>))*?Текущий тариф[^>]*>(?:&laquo;)?([\s\S]*?)(?:&raquo;)?(?:\s*?)?<\/h2>/i,
replaceTagsAndSpaces);if(e){AnyBalance.trace("Похоже на кабинет с несколькими номерами.");if(f.phone){a=switchNumberPost(b,a);if(/c\/pre\/index\.xhtml/i.test(a)){AnyBalance.trace("Дополнительный номер "+h+" предоплатный, но привязан к постоплатному кабинету...");a=AnyBalance.requestGet(b+"c/pre/index.xhtml",g_headers);fetchPre(b,a,c);return}a=AnyBalance.requestGet(b+"c/post/index.xhtml",g_headers)}if(AnyBalance.isAvailable("balance","currency")){var h=refreshBalance(b+"c/post/index.xhtml",a);getParam(h+
a,c,"balance",/Расходы по номеру за текущий период с НДС[\s\S]*?<div[^>]+class="[^>]*balan?ce-summ"[^>]*>([\s\S]*?)<\/div>/i,g,parseBalance);getParam(h+a,c,["currency","prebal","overpay","balance"],/Расходы по номеру за текущий период с НДС[\s\S]*?<div[^>]+class="[^>]*balan?ce-summ"[^>]*>([\s\S]*?)<\/div>/i,g,myParseCurrency)}}else if(AnyBalance.trace("Похоже на кабинет с одним номером."),f.phone)throw new AnyBalance.Error("Указан дополнительный номер телефона, но в кабинете нет прикрепленных номеров!");
var l=getParam(a,null,null,/<h1[^>]+class="phone-number"[^>]*>([\s\S]*?)<\/h1>/i,replaceTagsAndSpaces);getParam("POSTPAID",c,"type");processInfoPost_basic(b,a,c);isAvailableBonuses()&&(AnyBalance.trace("Запросим бонусы..."),h=a,0===getFoundBonuses(h).length&&(h=getBlock(b+"c/post/index.xhtml",a,"bonusesloaderDetails")),getBonuses(h,c));AnyBalance.isAvailable("overpay","prebal","currency","bills")&&(AnyBalance.trace("Получаем информацию статусе оплаты"),h=a,/<div[^>]+id="[^"]*:bills-info"/i.test(a)||
(h=getBlock(b+"c/post/index.xhtml",a,"callDetailsDetails")),getParam(h,c,"overpay",/<h4[^>]*>Переплата[\s\S]*?<span[^>]+class="price[^>]*>([\s\S]*?)<\/span>/i,g,parseBalance),getParam(h,c,"overpay",/<h4[^>]*>Осталось к оплате[\s\S]*?<span[^>]+class="price[^>]*>([\s\S]*?)<\/span>/i,g,parseBalanceNegative),getParam(h,c,"prebal",/Расходы по договору за текущий период:[\S\s]*?<div[^<]+class="balan?ce-summ"[^>]*>([\s\S]*?)<\/div>/i,g,parseBalance),getParam(h,c,["currency","prebal","overpay","balance"],
/Расходы по договору за текущий период:[\S\s]*?<div[^<]+class="balan?ce-summ"[^>]*>([\s\S]*?)<\/div>/i,g,myParseCurrency),sumParam(h,c,"bills",/<div[^>]+class="unpaid-bill-item"[\s\S]*?<span[^>]+class="price[^>]*>([\s\S]*?)<\/span>/ig,[/У вас нет неоплаченных счетов/i,"0",g],parseBalance,aggregate_sum),AnyBalance.trace(h),/информация[^<]*недоступна/i.test(h)&&AnyBalance.trace("Информация временно недоступна на сайте Билайн, попробуйте позже"));!e&&AnyBalance.isAvailable("balance","currency")&&(h=
refreshBalance(b+"c/post/index.xhtml",a),getParam(h+a,c,"balance",/Расходы по номеру за текущий период с НДС[\s\S]*?<div[^>]+class="[^>]*balan?ce-summ"[^>]*>([\s\S]*?)<\/div>/i,g,parseBalance),getParam(h+a,c,["currency","balance"],/Расходы по номеру за текущий период с НДС[\s\S]*?<div[^>]+class="[^>]*balan?ce-summ"[^>]*>([\s\S]*?)<\/div>/i,g,myParseCurrency));f.__debug&&(a=AnyBalance.requestGet(b+"c/operations/operationsHistory.xhtml"),a=getParam(a,null,null,/<span[^>]+class="date"[^>]*>([\s\S]*?)<\/span>/i,
replaceTagsAndSpaces),AnyBalance.trace("Последняя заявка: "+a));f=isAvailable("remainders.traffic_used")&&(!isset(c.remainders)||!isset(c.remainders.traffic_used));l&&(f||isAvailable("detalization"))&&(h=getParam(l,null,null,null,[/\+\s*7([\s\d\-]{10,})/i,"$1",/\D/g,""]),AnyBalance.trace("Пробуем получить данные по трафику из детализации по номеру: "+h),a=AnyBalance.requestGet(b+"c/post/fininfo/report/detailUnbilledCalls.xhtml?ctn="+h,g_headers),a=getBlockInner(b+"c/post/fininfo/report/detailUnbilledCalls.xhtml",
a,"retrieveSubCurPeriodDataDetails"),h=extractFromUpdate(a,"retrieveSubCurPeriodDataDetails"),/unbilledLoader:form:notifEmail/i.test(h)?AnyBalance.trace("Отчет получился слишком большой показа онлайн. Посылаем на почту"):f&&(c.remainders=c.remainders||{},getParam(h,c.remainders,"remainders.traffic_used",/Итоговый объем данных \(MB\):([^>]*>){3}/i,[replaceTagsAndSpaces,/([\s\S]*?)/,"$1 мб"],parseTraffic)),AnyBalance.isAvailable("detalization")&&processDetalizationPost(b,a,c));isAvailable(["expenses",
"payments"])&&(a=AnyBalance.requestGet(b+"c/post/fininfo/index.xhtml",g_headers),AnyBalance.isAvailable("expenses")&&processExpensesPost(b,a,c),AnyBalance.isAvailable("payments")&&processPaymentsPost(b,a,c));isAvailable(["total_balance"])&&(AnyBalance.trace("Пробуем получить данные по сумме всех номеров..."),a=AnyBalance.requestGet(b+"c/post/fininfo/index.xhtml",g_headers),getParam(a,c,"total_balance",/Сумма по всем номерам(?:[\s\S]*?<th[^>]*>){11}([\s\S]*?)<\/span/i,null,parseBalance));processInfo_settings(b,
c)}function processInfoPre_basic(b,a,c){AnyBalance.isAvailable("info.fio","info.region","info.phone","info.more3")&&(c.info||(c.info={}),getParam(a,c.info,"info.fio",/<p[^>]*>([^<,]*),(?:\s|&nbsp;|<[^>]*>)*Мы стремимся сделать/i,replaceTagsAndSpaces),processInfo_basic(b,a,c))}
function processInfo_settings(b,a){if(AnyBalance.isAvailable("info.email","info.address","info.birthday","info.fio")){b=AnyBalance.requestGet(b+"c/settings/enrichment/enrichment.xhtml",g_headers);a.info||(a.info={});a=a.info;getParam(b,a,"info.email",/Электронная почта[\s\S]*?<div[^>]+value-cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(b,a,"info.address",/<div[^>]+class="[^"]*address[^>]*>([\s\S]*?)<\/div>/i,[/Адрес проживания/i,"",replaceTagsAndSpaces]);var c=getElement(b,/<select[^>]+birthDay[^>]*>/i),
f=getElement(b,/<select[^>]+birthMonth[^>]*>/i),e=getElement(b,/<select[^>]+yearPeriods[^>]*>/i),g=create_aggregate_join(" ");sumParam(c,a,"info.birthday",/<option[^>]*selected[^>]*>([\s\S]*?)<\/option>/i,[/день/i,"",replaceTagsAndSpaces],null,g);sumParam(f,a,"info.birthday",/<option[^>]*selected[^>]*>([\s\S]*?)<\/option>/i,[/месяц/i,"",replaceTagsAndSpaces],null,g);sumParam(e,a,"info.birthday",/<option[^>]*selected[^>]*>([\s\S]*?)<\/option>/i,[/год/i,"",replaceTagsAndSpaces],null,g);isset(a.fio)&&
!/^[\s\-\d\+]*$/.test(a.fio)||getParam(b,a,"info.fio",/<div[^>]+class="name"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces)}}
function switchNumberPre(b,a){var c=AnyBalance.getPreferences();if(!/^\d{4,10}$/.test(c.phone))throw new AnyBalance.Error("Введите от 4 до 10 последних цифр номера дополнительного телефона без пробелов и разделителей или не вводите ничего, чтобы получить информацию по первому номеру!",null,!0);var f=getParam(a,null,null,new RegExp('div[^>]*(?:>)[^>]*onclick="\\s*selectAccount\\([\'\\"]\\d*'+c.phone+"['\\\"][^>]*","i"));if(!f)throw new AnyBalance.Error("Не найден присоединенный к договору номер телефона, оканчивающийся на "+
c.phone);c=getParam(f,null,null,/selectAccount\('([^']*)/,replaceSlashes);if(/sso-account-current/i.test(f))AnyBalance.trace("Дополнительный номер "+c+" уже выбран");else{AnyBalance.trace("Переключаемся на номер "+c);var e=getParam(a,null,null,/changeUser\s*=[^<]*?f:'([^']+)/,replaceSlashes),g=getParam(a,null,null,/changeUser\s*=[^<]*?s:'([^']+)/,replaceSlashes);e=getParam(a,null,null,new RegExp('<form[^>]+id="'+e+'"[^>]*>([\\s\\S]*?)</form>',"i"));if(!e)throw AnyBalance.trace(f),new AnyBalance.Error("Дополнительный номер "+
c+" найден, но переключиться на него не удалось. Возможны изменения в личном кабинете...");f=createFormParams(e);params=joinObjects(f,{"javax.faces.partial.ajax":"true","javax.faces.source":g,"javax.faces.partial.execute":"@all",newSsoLogin:c});params[g]=g;f=AnyBalance.requestPost(b+"c/pre/index.xhtml",params,addHeaders({Referer:b+"c/pre/index.xhtml"}));(c=getParam(f,null,null,/<redirect[^>]+url="([^"]+)/i,replaceHtmlEntities))?a=AnyBalance.requestGet(c,addHeaders({Referer:b+"c/pre/index.xhtml"})):
AnyBalance.trace("Не удалось переключить номер: "+f)}return a}
function fetchPre(b,a,c){var f=AnyBalance.getPreferences();AnyBalance.trace("Мы в предоплатном кабинете");f.phone&&(a=switchNumberPre(b,a));getParam("PREPAID",c,"type");f=getParam(a,null,null,/<h1[^>]+class="phone-number"[^>]*>([\s\S]*?)<\/h1>/i,replaceTagsAndSpaces);processInfoPre_basic(b,a,c);getParam(a,c,"tariff",/Текущий тариф[^>]*>(?:&laquo;)?([\s\S]*?)(?:&raquo;)?(?:\s*?)?<\/h2>/i,replaceTagsAndSpaces);if(AnyBalance.isAvailable("balance","currency","limit")){var e=function(){isset(c.balance)&&
null!=c.balance&&getParam(a+l,c,["currency","balance"],g,replaceTagsAndSpaces,myParseCurrency)},g=/<h3[^>]*>[^>]*class="price[^>]*>((?:[\s\S]*?span[^>]*>){3})/i;getParam(a,c,"balance",g,replaceTagsAndSpaces,parseBalance);var h=getElement(a,/<div[^>]+class="balance-credit"[^>]*>/i);getParam(h,c,"credit",/<h3[^>]*>([\s\S]*?)<\/h3>/i,replaceTagsAndSpaces,parseBalance);e();if(!isset(c.balance)||null==c.balance){var l=refreshBalance(b+"c/pre/index.xhtml",a);getParam(l,c,"balance",g,replaceTagsAndSpaces,
parseBalance);e()}}isAvailableBonuses()&&(l=getBonusesBlock(b+"c/pre/index.xhtml",a,"bonusesForm"),AnyBalance.trace(l),getBonuses(l,c));AnyBalance.isAvailable("detalization","payments","info.date_start")&&processDetailsAndPaymentsPre(b,f,c);processInfo_settings(b,c)}function isAvailableBonuses(){return AnyBalance.isAvailable("remainders")}
function getFoundBonuses(b){return(b=getElement(b,/<div[^>]+class="bonuses-accums[^>]*>/i))?getElements(b,/<div[^>]+class="(?:grouped-bonuses|item)[^>]*>/ig):[]}
function getBonuses(b,a,c){var f=getFoundBonuses(b);c?c="":(a=a.remainders=a.remainders||{},c="remainders.");AnyBalance.trace("Found "+f.length+" aggregated bonuses");c=c||"";0==f.length&&(AnyBalance.trace("Can`t find bonuses, tying to know why..."),AnyBalance.trace(getParam(b,null,null,/loading-failed"[^>]*>([^<]+)/i)));for(b=0;b<f.length;++b){var e=f[b];if(/^<div[^>]*item/i.test(e)){e=sumParam(e,null,null,/<div[^>]+class="\s*(?:(?:item\s*)?(?:accumulator|accumulator|bonus|item)?)[^"]*"(?:[\s\S](?!$|<div[^>]+class="(?:accumulator|accumulator|bonus|item)"))*[\s\S]/ig);
AnyBalance.trace("Found "+e.length+" bonuses");for(var g=/<div[^>]+class="[^>]*column2[^"]*"[^>]*>/i,h=[replaceTagsAndSpaces,/из.*/i,""],l=0;l<e.length;++l){var k=""+getParam(e[l],null,null,/<div[^>]+class="[^"]*column1[^"]*"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),m=getElement(e[l],g,replaceTagsAndSpaces),n=getParam(e[l],null,null,/class="[^>]*rest"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);AnyBalance.trace("Найдена опция "+k+": "+m+", rest: "+n);if(/Internet|Интернет|трафика|\d+\s+[гм]б/i.test(k))if(/(?:x|х)айвей|Интернет-трафик(?:а)?(?:\sна полной скорости)? по (?:услуге|тарифу)|Мобильного интернета|Мобильный интернет|Интернет\s*-?\s*трафик|\d+\s+[гм]б/i.test(k)){k=
function(q){return parseTraffic(q,p)};AnyBalance.trace("Пробуем разобрать новый трафик...");AnyBalance.trace("services[i] = "+e[l]);AnyBalance.trace("values = "+m);AnyBalance.trace("rest = "+n);var p=getParam(m,null,null,/((?:K|К|G|Г|M|М)?(?:B|Б))/i);p||(AnyBalance.trace("!units..."),p="mb");n?sumParam(n,a,c+"traffic_left",null,replaceTagsAndSpaces,k,aggregate_sum):(sumParam(m,a,[c+"traffic_left",c+"traffic_used"],/([^<]*)из/i,replaceTagsAndSpaces,k,aggregate_sum),sumParam(m,a,[c+"traffic_total",
c+"traffic_used"],/из([^<]*)/i,replaceTagsAndSpaces,k,aggregate_sum),isset(a.traffic_left)&&isset(a.traffic_total)&&sumParam(a.traffic_total-a.traffic_left,a,c+"traffic_used",null,null,null,aggregate_sum))}else sumParam(m,a,c+"traffic_left"+(/ноч/i.test(k)?"_night":""),null,replaceTagsAndSpaces,parseTraffic,aggregate_sum);else/SMS|СМС|штук/i.test(k)?sumParam(m,a,c+"sms_left",null,replaceTagsAndSpaces,parseBalance,aggregate_sum):/MMS/i.test(k)?sumParam(m,a,c+"mms_left",null,replaceTagsAndSpaces,parseBalance,
aggregate_sum):/Рублей БОНУС|бонус-баланс|Дополнительный баланс/i.test(k)?sumParam(m,a,c+"rub_bonus",null,replaceTagsAndSpaces,parseBalance,aggregate_sum):/Денежный бонус/i.test(k)?(getParam(m,a,c+"rub_bonus2",null,replaceTagsAndSpaces,parseBalance),getParam(e[l],a,c+"rub_bonus2_till",/<div[^>]+class="column3[^"]*"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseDateWord)):/Рублей за участие в опросе|Счастливое время|Бонусы по программе|Счастливого времени/i.test(k)?sumParam(m,a,c+"rub_opros",
null,replaceTagsAndSpaces,parseBalance,aggregate_sum):/Минут[^<]+на\s*(?:все\s*)?номера вашего региона|Времени общения|Включенные минуты|Пакет минут|Минут общения на номера вашего региона|минут в месяц|мин\.|Голосовой трафик|Разговор.*вне сети/i.test(k)?(sumParam(m,a,c+"min_local",null,h,parseMinutes,aggregate_sum),sumParam(e[l],a,c+"min_local_till",/Доступно до([^<]{10,20})/i,replaceTagsAndSpaces,parseDateWord,aggregate_min)):/Секунд БОНУС\s*\+|Баланс бонус-секунд/i.test(k)?sumParam(m,a,c+"min_bi",
null,h,parseMinutes,aggregate_sum):/Секунд БОНУС-2|Баланс бесплатных секунд-промо/i.test(k)?(sumParam(m,a,c+"min_left_1",null,h,parseMinutes,aggregate_sum),sumParam(e[l],a,c+"min_local_till",/Доступно до([^<]{10,20})/i,replaceTagsAndSpaces,parseDateWord,aggregate_min)):/Минут общения|вызовы|на местные номера|Остаток разговоров|Разговоры/i.test(k)?/местные.*вызовы|любые номера Вашего региона|^Минут общения по тарифу$|(?:всех|других|любых)\s*(?:сотовых|мобильных)?\s*операторов|все номера|На номера домашнего региона|Минут общения по тарифу Все для бизнеса Бронза|кроме номеров .?Билайн.?|на местные номера других операторов|любые местные|другие мобильные/i.test(k)?
sumParam(m,a,c+"min_local",null,h,parseMinutes,aggregate_sum):sumParam(m,a,c+"min_bi",null,h,parseMinutes,aggregate_sum):/Баланс для оплаты дополнительных услуг/i.test(k)||AnyBalance.trace("Неизвестная опция: "+k+" "+e[l])}}else AnyBalance.trace("Пропускаем grouped-bonuses: "+e)}}
function getTempPasswordSMS(b,a){var c=AnyBalance.getPreferences(),f=b+"s/recoveryPassSSO.xhtml";do{var e=getParam(a,null,null,/<form[^>]+id="form"[^>]*>[\s\S]*?<\/form>/i);if(!e)throw AnyBalance.trace(a),new AnyBalance.Error("Не удаётся найти форму регистрации. Проблемы на сайте или сайт изменен");var g;a=createFormParams(e,function(k,m,n,p){/login/i.test(n)?p=c.login:"kaptchaId"==n?(k=AnyBalance.requestPost(b+"captcha.jpg","",addHeaders({"X-Requested-With":"XMLHttpRequest",Referer:f})),k=getJson(k),
g=k.url,p=k.id):/kaptchaInput/i.test(n)&&(k=getParam(e,null,null,/<div[^>]+ui-message-error[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),m=AnyBalance.requestGet(b+g,g_headers),p=AnyBalance.retrieveCode((k||"")+"\nВведите, пожалуйста, символы с картинки.",m,{time:3E5}));return p});var h=getParam(e,null,null,/<button[^>]+loginInnerBlock[^>]*>/i);if(!h)throw AnyBalance.trace(e),new AnyBalance.Error("Не удаётся найти кнопку подтверждения регистрации. Проблемы на сайте или сайт изменен");h=getParam(h,
null,null,/name="([^"]*)/i,replaceHtmlEntities);a["javax.faces.partial.ajax"]="true";a["javax.faces.source"]=h;a["javax.faces.partial.execute"]="@all";a["javax.faces.partial.render"]="loginInnerBlock";a[h]=h;l&&(a["javax.faces.ViewState"]=l);h=AnyBalance.requestPost(f,a,addHeaders({"X-Requested-With":"XMLHttpRequest"}));var l=extractFromUpdate(h,"ViewState:0");a=extractFromUpdate(h,"loginInnerBlock",!0)}while(/kaptchaInput/i.test(a));return h}
function createNewPassword(b){return createNewPasswordApi()}function loginWithoutPassword(b){var a=createNewPassword(b);b=AnyBalance.requestGet(b,g_headers);b=getLKType(b);b.password=a;return b}
function turnOffSMSNotification(b){b+="c/settings/notifications/notifications.xhtml";var a=AnyBalance.requestGet(b,g_headers),c=getParam(a,null,null,/<form[^>]+name="notificationEventsForm"[^>]*>[\s\S]*?<\/form>/i);if(!c)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти форму управления уведомлениями.");a=getParam(c,null,null,/(<input[^>]+id="notificationEventsForm:[^>]*Вход в личный кабинет[^>]*>)/i,replaceHtmlEntities);if(!a)throw AnyBalance.trace(c),new AnyBalance.Error("Не удалось найти галочку отключения уведомления.");
var f=getParam(a,null,null,/name="([^"]*)/i,replaceHtmlEntities);if(getParam(a,null,null,/\s+checked=/i,replaceHtmlEntities)){a=createFormParams(c,function(g,h,l,k){l==f&&(k=void 0);return k});var e=getParam(c,null,null,/<button[^>]*u:'notificationEventsForm'[^>]*>/i);if(!e)throw AnyBalance.trace(c),new AnyBalance.Error("Не удалось найти кнопку сохранения уведомлений.");c=getParam(e,null,null,/s:'([^']*)/,replaceHtmlEntities);a["javax.faces.partial.ajax"]="true";a["javax.faces.source"]=c;a["javax.faces.partial.execute"]=
"@all";a["javax.faces.partial.render"]="notificationEventsForm";a[c]=c;a=AnyBalance.requestPost(b,a,g_headers);a=extractFromUpdate(a,"notificationEventsForm",!0);if(!/Настройки уведомлений успешно сохранены/i.test(a))throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось сохранить уведомления");AnyBalance.trace("Уведомление о входе отменено успешно!")}else AnyBalance.trace("Уведомление о входе уже выключено. Отлично :)")}
function generatePassword(){var b=String.fromCharCode("A".charCodeAt()+Math.floor(26*Math.random()));b+=String.fromCharCode("0".charCodeAt()+Math.floor(10*Math.random()));for(var a=0;4>a;++a)b+=String.fromCharCode("a".charCodeAt()+Math.floor(26*Math.random()));return b}
function sheet_to_array(b){var a=[];if(null==b||null==b["!ref"])return a;var c=XLS.utils.decode_range(b["!ref"]),f=[],e,g;for(g=c.s.c;g<=c.e.c;++g)f[g]=XLS.utils.encode_col(g);for(e=c.s.r;e<=c.e.r;++e){var h=[];var l=XLS.utils.encode_row(e);for(g=c.s.c;g<=c.e.c;++g){var k=b[f[g]+l];k=void 0!==k?""+XLS.utils.format_cell(k):"";h[g]=k}a.push(h)}return a};var g_baseurlApi="https://my.beeline.ru/api/",g_apiHeaders={"User-Agent":"okhttp/2.6.0","Client-Type":"MYBEE/ANDROID/PHONE/2.90"};
function callAPIProc(b,a,c,f){b=g_baseurlApi+b;var e={AUTH_ERROR:" Ошибка авторизации! Проверьте логин-пароль!","for.existent.users.only":"Неправильный логин"};if(a){var g=0>b.indexOf("?")?"?":"&",h;for(h in a)b+=g+encodeURIComponent(h)+"="+encodeURIComponent(a[h]),g="&"}a=f||c?AnyBalance.requestPost(b,c&&JSON.stringify(c),addHeaders({"Content-Type":c?"application/json; charset=UTF-8":void 0},g_apiHeaders),{HTTP_METHOD:f||"POST"}):AnyBalance.requestGet(b,g_apiHeaders);g=getJson(a);if("OK"!=g.meta.status)throw e=
e[g.meta.message]||g.meta.message||"",c&&c.password&&(c.password="**********"),AnyBalance.trace("Request ("+f+"): "+b+", "+JSON.stringify(c)+"\nResponse: "+a),new AnyBalance.Error("Ошибка вызова API! "+e,null,/парол|логин/i.test(e));return g}
function apiLogin(b){b&&(g_baseurlApi=b+"api/");b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");try{getApiAssocNumbers();AnyBalance.trace("Уже залогинены, используем имеющийся вход");return}catch(c){AnyBalance.trace("Сессия новая, надо логиниться.")}if(!b.password){AnyBalance.trace("Пароль не задан, получаем его по смс");var a=createNewPasswordApi()}b=callAPIProc("2.0/auth/auth",{userType:"Mobile",login:b.login},{password:b.password||a},"PUT");AnyBalance.setCookie(getParam(g_baseurlApi,
null,null,/:\/\/([^\/]*)/),"token",b.token);__setLoginSuccessful();return a}function getApiAssocNumbers(){if(getApiAssocNumbers.json)return getApiAssocNumbers.json;var b=AnyBalance.getPreferences();b=callAPIProc("1.0/sso/list",{login:b.login});AnyBalance.trace("Присоединенных номеров: "+b.ssoAccountList.length);return getApiAssocNumbers.json=b}
function getApiSubscribers(b){getApiSubscribers.json||(getApiSubscribers.json={});if(getApiSubscribers.json[b])return getApiSubscribers.json[b];var a=callAPIProc("1.0/sso/subscribers",{login:b});AnyBalance.trace("CTN на логине: "+a.subscribers.length);return getApiSubscribers.json[b]=a}
function switchToAssocNumber(b){for(var a=AnyBalance.getPreferences(),c=getApiAssocNumbers(),f=0;f<c.ssoAccountList.length;++f){var e=c.ssoAccountList[f];a:{var g=e.name;var h=getApiSubscribers(g).subscribers;if(h&&h.length){for(var l=0;l<h.length;++l){var k=h[l];if(b&&endsWith(k.ctn,b)){AnyBalance.trace("В качестве CTN берем "+k.ctn+" по заданным последним цифрам");a.__login=g;g=a.phone=k.ctn;break a}if(!b&&k.ctnDefault){AnyBalance.trace("В качестве CTN берем "+k.ctn+" по умолчанию");a.__login=g;
g=a.phone=k.ctn;break a}}if(!b){AnyBalance.trace("В качестве CTN берем "+h[0].ctn);a.__login=g;g=a.phone=h[0].ctn;break a}}g=void 0}if(g)return AnyBalance.trace("Используем присоединенный логин "+e.name+" и номер "+g),g}throw new AnyBalance.Error("Не удалось найти присоединенный номер, оканчивающийся на "+b);}
function processApi(b){var a=AnyBalance.getPreferences();processApi.payType||(processApi.payType={});if(!processApi.payType[a.phone]){var c=callAPIProc("1.0/info/payType",{ctn:a.phone});AnyBalance.trace("Тип кабинета: "+c.payType);processApi.payType[a.phone]=c.payType}getParam(processApi.payType[a.phone],b,"type");processApiInfo(b);"function"==typeof processApiPayments&&processApiPayments(b);processApiServices(b);processApiTariff(b);"PREPAID"==processApi.payType[a.phone]?processApiPrepaid(b):processApiPostpaid(b)}
function processApiTariff(b){if(AnyBalance.isAvailable("tariff")){var a=AnyBalance.getPreferences();a=callAPIProc("1.0/info/pricePlan",{ctn:a.phone});getParam(a.pricePlanInfo.entityName,b,"tariff")}}
function processApiInfo(b){if(AnyBalance.isAvailable("info","agreement")){var a=AnyBalance.getPreferences(),c=callAPIProc("1.0/sso/contactData",{login:a.login});b.info||(b.info={});var f=b.info,e=create_aggregate_join(" ");c.lastName&&(getParam(c.lastName,f,"info.name_last"),sumParam(c.lastName,f,"info.fio",null,null,null,e));c.firstName&&c.firstName!=a.login&&(getParam(c.firstName,f,"info.name"),sumParam(c.firstName,f,"info.fio",null,null,null,e));getParam(c.invoiceAddr,f,"info.address");getParam(c.market,
f,"info.region");getParam(a.phone,f,"info.phone",/^\d{10}$/,[/(\d{3})(\d{3})(\d{2})(\d{2})/,"+7 $1 $2-$3-$4"]);getParam(""+c.ban,b,"agreement")}}
function processApiPrepaid(b){var a=AnyBalance.getPreferences();AnyBalance.isAvailable("balance","currency","currency_code")&&(a=callAPIProc("1.0/info/prepaidBalance",{ctn:a.phone}),getParam(a.balance,b,"balance",null,null,apiParseBalanceRound),getParam(a.currency,b,["currency_code","balance"]),getParam(g_currencys[a.currency],b,["currency","balance"]));try{processApiRemaindersPrepaid(b)}catch(c){AnyBalance.trace("Не удалось получить бонусы: "+c.message)}"function"==typeof processApiDetalizationPrepaid&&
processApiDetalizationPrepaid(b)}
function processApiRemaindersPrepaid(b){if(AnyBalance.isAvailable("remainders")){b=b.remainders={};for(var a=AnyBalance.getPreferences(),c=callAPIProc("1.0/info/accumulators",{ctn:a.phone}),f=0;f<c.accumulators.length;f++){var e=c.accumulators[f];"SECONDS"==e.unit?/на междугородные номера|на междугородные звонки/i.test(e.restName||e.accName)?sumParam(e.rest+" "+e.unit,b,"remainders.min_left_2",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum):isLocalMin(e.restName||e.accName)?sumParam(e.rest+
" "+e.unit,b,"remainders.min_local",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum):sumParam(e.rest+" "+e.unit,b,"remainders.min_bi",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum):"SMS"==e.unit?sumParam(e.rest+" "+e.unit,b,"remainders.sms_left",null,replaceTagsAndSpaces,parseBalance,aggregate_sum):"MMS"==e.unit?sumParam(e.rest+" "+e.unit,b,"remainders.mms_left",null,replaceTagsAndSpaces,parseBalance,aggregate_sum):"KBYTE"==e.unit?"ROAMGPRS"==e.soc?sumParam(e.rest+" "+e.unit,b,["remainders.traffic_rouming"],
null,replaceTagsAndSpaces,parseTraffic,aggregate_sum):(sumParam(e.rest+" "+e.unit,b,["remainders.traffic_left","remainders.traffic_used"],null,replaceTagsAndSpaces,parseTraffic,aggregate_sum),sumParam(e.size+" "+e.unit,b,["remainders.traffic_total","remainders.traffic_used"],null,replaceTagsAndSpaces,parseTraffic,aggregate_sum),isset(b.traffic_total)&&isset(b.traffic_left)&&sumParam(b.traffic_total-b.traffic_left,b,"remainders.traffic_used",null,null,null,aggregate_sum)):AnyBalance.trace("Unknown units: "+
JSON.stringify(e))}AnyBalance.trace(JSON.stringify(b));c=callAPIProc("1.0/info/prepaidAddBalance",{ctn:a.phone});for(var g in c)if(isArray(c[g]))for(a=0;a<c[g].length;a++)e=c[g][a],/bonusopros/i.test(e.name)?sumParam(e.value+"",b,"remainders.rub_opros",null,replaceTagsAndSpaces,apiParseBalanceRound,aggregate_sum):/bonusmoney/i.test(e.name)?sumParam(e.value+"",b,"remainders.rub_bonus",null,replaceTagsAndSpaces,apiParseBalanceRound,aggregate_sum):/comverse.balance.name.bonusbalance17/i.test(d.name)?
(getParam(e.value+"",b,"remainders.rub_bonus2",null,replaceTagsAndSpaces,apiParseBalanceRound),getParam(e.dueDate,b,"remainders.rub_bonus2_till",null,replaceTagsAndSpaces,parseDateISO)):/bonusseconds/i.test(e.name)?sumParam(e.value+"",b,"remainders.min_left_1",null,replaceTagsAndSpaces,apiParseBalanceRound,aggregate_sum):/seconds/i.test(e.name)?sumParam(e.value+"",b,"remainders.min_local",null,replaceTagsAndSpaces,apiParseBalanceRound,aggregate_sum):/internet/i.test(e.name)?sumParam(e.value+"б",b,
"remainders.traffic_left",null,replaceTagsAndSpaces,parseTraffic,aggregate_sum):/mms/i.test(e.name)?sumParam(e.value+"",b,"remainders.mms_left",null,replaceTagsAndSpaces,parseBalance,aggregate_sum):/sms/i.test(e.name)?sumParam(e.value+"",b,"remainders.sms_left",null,replaceTagsAndSpaces,parseBalance,aggregate_sum):AnyBalance.trace("Unknown option: "+g+" "+JSON.stringify(e))}}
function getPostpaidBalanceApi(b){getPostpaidBalanceApi.json||(getPostpaidBalanceApi.json={});if(getPostpaidBalanceApi.json[b])return getPostpaidBalanceApi.json[b];AnyBalance.getPreferences();json=callAPIProc("1.0/info/postpaidBalance",{ctn:b});return getPostpaidBalanceApi.json[b]=json}
function processApiPostpaid(b){var a=AnyBalance.getPreferences();isAvailable(["balance","currency","currency_code"])&&(json=getPostpaidBalanceApi(a.phone),getParam(json.balance+"",b,"balance",null,replaceTagsAndSpaces,apiParseBalanceRound),getParam(json.currency,b,["currency_code","balance"],null,replaceTagsAndSpaces),getParam(g_currencys[json.currency],b,["currency","balance"],null,replaceTagsAndSpaces));if(AnyBalance.isAvailable("prebal")){for(var c=getApiSubscribers(a.__login).subscribers,f=0,
e=0;c&&e<c.length;++e)f+=getPostpaidBalanceApi(c[e].ctn).balance;getParam(f,b,"prebal")}if(isAvailable("overpay"))try{json=callAPIProc("1.0/info/postpaidDebt",{ctn:a.phone}),getParam(json.balance+"",b,"overpay",null,replaceTagsAndSpaces,function(g){return-1*(apiParseBalanceRound(g)||0)})}catch(g){AnyBalance.trace("Не удалось получить переплату: "+g.message)}try{processApiRemaindersPostpaid(b)}catch(g){AnyBalance.trace("Не удалось получить постоплатные бонусы: "+g.message)}}
function isLocalMin(b){return/номера других|на других|на все номера|др(?:угих|\.) операторов|всех|любых|местные.*вызовы|любые местные|кроме номеров .?Билайн.?/i.test(b)}
function processApiRemaindersPostpaid(b){if(AnyBalance.isAvailable("remainders")){b=b.remainders={};var a=AnyBalance.getPreferences();a=callAPIProc("1.0/info/rests",{ctn:a.phone});for(var c=0;c<a.rests.length;c++){var f=a.rests[c];"VOICE"==f.unitType?isLocalMin(f.restName||f.accName)?sumParam(f.currValue+" ",b,"remainders.min_local",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum):sumParam(f.currValue+" ",b,"remainders.min_bi",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum):"SMS_MMS"==
f.unitType?sumParam(f.currValue+" "+f.unit,b,"remainders.sms_left",null,replaceTagsAndSpaces,parseBalance,aggregate_sum):"MMS"==f.unitType?sumParam(f.currValue+" "+f.unit,b,"remainders.mms_left",null,replaceTagsAndSpaces,parseBalance,aggregate_sum):"INTERNET"==f.unitType?(sumParam(f.currValue+" mb",b,["remainders.traffic_left","remainders.traffic_used"],null,replaceTagsAndSpaces,parseTraffic,aggregate_sum),sumParam(f.initialSize+" mb",b,["remainders.traffic_total","remainders.traffic_used"],null,
replaceTagsAndSpaces,parseTraffic,aggregate_sum),isset(b.traffic_total)&&isset(b.traffic_left)&&sumParam(b.traffic_total-b.traffic_left,b,"remainders.traffic_used",null,null,null,aggregate_sum)):AnyBalance.trace("Unknown units: "+JSON.stringify(f))}}}function apiParseBalanceRound(b){b=parseBalance(b+"");return isset(b)?Math.round(100*b)/100:null}
function processApiServices(b){if(AnyBalance.isAvailable("services_count","services_abon")){var a=AnyBalance.getPreferences();a=callAPIProc("1.0/info/serviceList",{ctn:a.phone});getParam(0,b,"services_abon");getParam(0,b,"services_count");for(var c=0;c<a.services.length;++c){var f=a.services[c];f.rcRate&&(AnyBalance.trace("Платная услуга "+f.entityName+" "+f.rcRate+" "+f.rcRatePeriodText),sumParam(f.rcRate,b,"services_abon",null,null,null,aggregate_sum));"Y"==f.viewInd&&sumParam(1,b,"services_count",
null,null,null,aggregate_sum)}}}
function createNewPasswordApi(){var b=AnyBalance.getPreferences();checkEmpty(b.login,"Введите 10 цифр вашего номера телефона в формате 9031234567");checkEmpty(!b.password||6<=b.password.length,"Введите не менее 6 символов желаемого пароля. Или оставьте поле пустым, чтобы автоматически сгенерировать пароль.");var a=callAPIProc("1.0/passReset",{login:b.login,channelType:"CTN"}),c=a=AnyBalance.retrieveCode("Пожалуйста, введите временный пароль, который направлен вам по "+a.channel,null,{inputType:"number"});
a=callAPIProc("2.0/auth/auth",{userType:"Mobile",login:b.login},{password:a},"PUT");AnyBalance.setCookie(getParam(g_baseurlApi,null,null,/:\/\/([^\/]*)/),"token",a.token);a.tempPassInd&&(c=b.password||generatePassword(),callAPIProc("1.0/setting/changePassword",{login:b.login,newPassword:c},"","PUT"));createNewPasswordApi.password=c;b.password=c;AnyBalance.trace("Generated new password: "+c);return c}
function processPaymentsPost(b,a,c){var f=getElements(a,[/<a[^>]*payments_form[^>]*>/ig,/Выгрузить в Excel/i])[0];f=getParam(f,null,null,/mojarra.jsfcljs[^"]*'([^']*:payments_form:[^'\\]*)/i);var e=getParam(f,null,null,/.*payments_form/i);if(e=getElement(a,new RegExp('<form[^>]+name="'+e+'"[^>]*>',"i"))){var g=new Date,h=new Date(g.getFullYear(),g.getMonth(),g.getDate()-90);a=createFormParams(e,function(k,m,n,p){return/DateFrom/.test(n)?fmtDate(h).replace(/\d\d(\d\d)/,"$1"):/DateTo/.test(n)?fmtDate(g).replace(/\d\d(\d\d)/,
"$1"):p});a[f]=f;b=AnyBalance.requestPost(b+"c/post/fininfo/index.xhtml",a,addHeaders({Referer:b}),{options:{FORCE_CHARSET:"base64"}});b=XLS.read(b,{type:"base64"});b=sheet_to_array(b.Sheets[b.SheetNames[0]]);AnyBalance.trace("Найдено "+b.length+" строк платежей");c=c.payments=[];a={date:{re:/Дата/i,result_func:parseDate},type:{re:/Тип/i,result_func:null},sum:{re:/Сумма/i}};f=initCols(a,b[0]);for(e=1;e<b.length;e++){var l={};fillColsResult(a,f,b[e],l,"payments.");c.push(l)}}else AnyBalance.trace(a),
AnyBalance.trace("Не найдена форма получения платежей, сайт изменен?")}
function processDetailsAndPaymentsPre(b,a,c){var f=new Date,e=new Date(f.getFullYear(),f.getMonth()-1,f.getDate());f=f.getFullYear()+"-"+n2(f.getMonth()+1)+"-"+n2(f.getDate());e=e.getFullYear()+"-"+n2(e.getMonth()+1)+"-"+n2(e.getDate());a=replaceAll(a,[/\+\s*7/,"",/\D/g,""]);AnyBalance.isAvailable("payments")&&processPaymentsPre(b,a,e,f,c);AnyBalance.isAvailable("detalization","info.date_start")&&processDetalizationPre(b,a,e,f,c)}
function processPaymentsPre(b,a,c,f,e){b=callSiteApi(b,"info/payments/history?ctn="+a+"&periodStart="+c+"&periodEnd="+f);processApiPayments0(b,e)}function processApiPayments(b){if(AnyBalance.isAvailable("payments"))try{var a=AnyBalance.getPreferences(),c=callAPIProc("1.0/info/payments/history",{ctn:a.phone});processApiPayments0(c,b)}catch(f){AnyBalance.trace("Не удалось получить историю платежей: "+f.message)}}
function processApiPayments0(b,a){a.payments=[];AnyBalance.trace("Найдено платежей: "+b.paymentsHistory.length);for(var c=0;c<b.paymentsHistory.length;++c){var f=b.paymentsHistory[c],e={};getParam(f.dateStart,e,"payments.date",null,null,parseDateISO);getParam(f.value,e,"payments.sum",null,null,parseBalance);getParam(f.paymentType,e,"payments.type_code");getParam(f.paymentStatus,e,"payments.status_code");getParam(f.payTypeName,e,"payments.type");f.payPoint&&getParam(f.payPoint,e,"payments.place");
a.payments.push(e)}};
