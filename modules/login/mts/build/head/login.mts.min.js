var g_baseurlLogin="http://login.mts.ru";
function checkLoginError(a,c){function b(a){var b=sumParam(a,/var\s+(?:passwordErr|loginErr)\s*=\s*'([^']*)/g,replaceSlashes,null,aggregate_join);b||(b=getElement(a,/<[^>]+field-help/i,replaceTagsAndSpaces));if(b)throw new AnyBalance.Error(b,null,/логин|парол/i.test(b));if(b=getElement(a,/<div[^>]+b-page_error__msg[^>]*>/,replaceTagsAndSpaces))throw new AnyBalance.Error(b);}var f=AnyBalance.getPreferences(),d=c.url;b(a);var e=getElement(a,/<[^>]+captcha-wrapper/i);e&&(e=getParam(e,/data:image\/\w+;base64,([^'"]+)/i,
replaceHtmlEntities));e&&0<=e.indexOf("iVBORw0KGgoAAAANSUhEUgAAANMAAAA6CAIAAAClLvvEAAAeQElEQVR42u3de7yVVZkH8NTQSi3N7uUltQuaoGFp")&&(AnyBalance.trace("Капча спрятана. Ищем её в другом месте"),e=null);e||(e=getParam(a,/"(ZGF0YTppbWFnZS[^"]*)/),e=Base64.decode(e));e&&(e=getParam(e,/data:image\/\w+;base64,([^'"]+)/i));if(e){AnyBalance.trace("МТС решило показать капчу :( Жаль");var g=AnyBalance.retrieveCode("МТС требует ввести капчу для входа в личный кабинет, чтобы подтвердить, что вы не робот. Введите символы, которые вы видите на картинке.",
e);a=getElement(a,/<form[^>]+name="Login"/i);e=createFormParams(a,function(a,b,d,c){"IDToken1"==d&&(c=f.login);"IDToken2"==d&&(c=g);return c});AnyBalance.trace("Логинимся с заданным номером и капчей");a=AnyBalance.requestPost(d,e,addHeaders({Origin:g_baseurlLogin,Referer:d}));fixCookies();500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),a=AnyBalance.requestPost(d,e,addHeaders({Origin:g_baseurlLogin,Referer:d})),fixCookies());if(500<=
AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",allowRetry);isOnLogin()&&getOrdinaryLoginForm(a)&&(a=loginOrdinaryForm(a,c));0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)&&b(a)}else if(/МТС\s*-\s*Установка пароля/i.test(a)){AnyBalance.trace("МТС потребовало установить пароль. Установим старый");a=getElement(a,/<form[^>]+name="Login"/i);e=createFormParams(a,function(a,b,c,d){"IDToken2"==
c&&(d=g);return d});a=AnyBalance.requestPost(d,e,addHeaders({Origin:g_baseurlLogin,Referer:d}));fixCookies();if(/Ваш пароль успешно/i.test(a))throw AnyBalance.trace(a),new AnyBalance.Error("МТС потребовала установить новый пароль, автоматическая установка старого не удалась. Сайт изменен?");a=getElement(a,/<form[^>]+name="Login"/i);e=createFormParams(a);a=AnyBalance.requestPost(d,e,addHeaders({Origin:g_baseurlLogin,Referer:d}));fixCookies()}else throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти капчу. Сайт изменен?");
return a}
function redirectIfNeeded(a){if(/<body[^>]+onload[^>]+submit/i.test(a)){AnyBalance.trace("Потребовался редирект формой...");var c=createFormParams(a),b=getParam(a,/<form[^>]+action=['"]([^'"]*)/,replaceHtmlEntities);b=b.replace(/^https:\/\/login\.mts\.ru(?::443)?/,"http://login.mts.ru");a=AnyBalance.getLastUrl();a=AnyBalance.requestPost(joinUrl(a,b),c,addHeaders({Refefer:a}));fixCookies()}if(c=getParam(a,/<meta[^>]+http-equiv="REFRESH"[^>]*content="0;url=([^";]*)/i,replaceHtmlEntities))AnyBalance.trace("Потребовался get редирект..."),c=
c.replace(/^https:\/\/login\.mts\.ru/,"http://login.mts.ru"),a=AnyBalance.getLastUrl(),a=AnyBalance.requestGet(joinUrl(a,c),addHeaders({Refefer:a})),fixCookies();return a}function isOnLogin(){return 0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)}function getOrdinaryLoginForm(a){return getElement(a,/<form[^>]+name="Login"/i)}
function enterMtsLK(a){var c=a.url||g_baseurlLogin,b=AnyBalance.requestGet(c,g_headers);fixCookies()&&(AnyBalance.trace("Куки исправлены на входе..."),b=AnyBalance.requestGet(AnyBalance.getLastUrl(),g_headers),fixCookies());500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),b=AnyBalance.requestGet(c,g_headers),fixCookies());if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...");
/Произошла ошибка при попытке авторизации/i.test(b)&&(AnyBalance.trace("Куки протухли :( Придется авторизоваться заново"),clearAllCookies(),b=AnyBalance.requestGet(c,g_headers),fixCookies());fixCookies()&&(AnyBalance.trace("Куки исправлены, перезагружаем страницу. Пробуем ещё разок..."),b=AnyBalance.requestGet(AnyBalance.getLastUrl(),g_headers),fixCookies());b=redirectIfNeeded(b);if(c=getParam(b,/Продолжить вход с номером([\s\S]*?)<\/[bp]/i,replaceTagsAndSpaces)){AnyBalance.trace("Предлагает автоматически залогиниться на "+
c);b=getElement(b,/<form[^>]+name="Login"/i);if(endsWith(c.replace(/\D+/g,""),a.login)){AnyBalance.trace("А нам этот номер и нужен. Соглашаемся...");var f="Login"}else AnyBalance.trace("А нам нужен номер "+a.login+". Отказываемся..."),f="Ignore";b=createFormParams(b,function(a,b,c,h){"IDButton"==c&&(h=f);return h});b=AnyBalance.requestPost(AnyBalance.getLastUrl(),b,addHeaders({Referer:AnyBalance.getLastUrl()}));fixCookies()}isOnLogin()?(a.html=b,a.url||(a.url=AnyBalance.getLastUrl()),b=enterMTS(a)):
AnyBalance.trace("Мы не на странице логина. Внутри уже?");if(isOnLogin())throw AnyBalance.trace(b),new AnyBalance.Error("Не удаётся зайти в личный кабинет");return b}
function fixCookies(){for(var a=AnyBalance.getCookies(),c=!1,b=0;b<a.length;++b){var f=a[b];/^login|REDIRECT_BACK_SERVER_URL$/i.test(f.name)&&!/^"/.test(f.value)&&(c='"'+f.value+'"',AnyBalance.trace("Исправляем куки "+f.name+" на "+c),AnyBalance.setCookie(f.domain,f.name,c,f),c=!0)}AnyBalance.getCookie("login")||AnyBalance.setCookie("login.mts.ru","login",'"https://login.mts.ru:443/amserver/UI/Login?service=lk&goto=http%3A%2F%2Flk.mts.ru%2F"',{path:"/amserver/UI/Login"});return c}
function saveLoginCookies(){var a=AnyBalance.getPreferences();AnyBalance.setData("login",a.login+"-v1");AnyBalance.saveCookies();AnyBalance.saveData()}function restoreLoginCookies(){var a=AnyBalance.getPreferences();AnyBalance.getData("login")===a.login+"-v1"&&AnyBalance.restoreCookies()}
function loginOrdinaryForm(a,c){AnyBalance.getPreferences();AnyBalance.trace("Найдена обычная форма входа");var b=getOrdinaryLoginForm(a);a=createFormParams(b,function(a,b,e,g){"IDToken1"==e?g=c.login:"IDToken2"==e?g=c.password:"noscript"==e?g=void 0:"IDButton"==e&&(g="Submit");return g});if(b=getParam(b,/data-sitekey="([^"]*)/i,replaceHtmlEntities))AnyBalance.trace("МТС требует рекапчу :("),b=solveRecaptcha("МТС требует ввода рекапчи, как и при входе через браузер. Пожалуйста, докажите, что вы не робот.",
loginUrl,b),a.IDToken3=b;AnyBalance.trace("Логинимся с заданным номером");a=AnyBalance.requestPost(c.url,a,addHeaders({Origin:g_baseurlLogin,Referer:c.url}));fixCookies();return a}
function enterMTS(a){var c=a.baseurl||g_baseurl,b=a.url=a.url||g_baseurlLogin+"/amserver/UI/Login?goto="+c,f=a.allowRetry,d=a.html;fixCookies();if(!d||!getOrdinaryLoginForm(d))if(d=AnyBalance.requestGet(b,g_headers),fixCookies(),500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),d=AnyBalance.requestGet(b,g_headers),fixCookies()),500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...",
f);if(0==AnyBalance.getLastUrl().indexOf(c))return d;d=redirectIfNeeded(d);if(c=getOrdinaryLoginForm(d))d=loginOrdinaryForm(d,a);else if(c=getElement(d,/<form[^>]+id="login-phone-form"/i)){AnyBalance.trace("Найдена корп. форма входа");var e=createFormParams(c,function(b,c,d,e){"IDToken1"==d&&(e=a.login);return e});d=AnyBalance.requestPost(b,e,addHeaders({Origin:g_baseurlLogin,Referer:b}));fixCookies();c=getElement(d,/<form[^>]+id="enter-password-form"/i);if(!c){if(b=getElement(d,/<[^>]+intro-text/i,
replaceTagsAndSpaces))throw new AnyBalance.Error(b,null,/не существует/i.test(b));AnyBalance.trace(d);throw new AnyBalance.Error("Не удалось найти форму ввода пароля. Сайт изменен?");}e=createFormParams(c,function(b,c,d,e){"IDToken1"==d?e=a.login:"IDToken2"==d&&(e=a.password);return e});d=AnyBalance.requestPost(b,e,addHeaders({Origin:g_baseurlLogin,Referer:b}));fixCookies()}else{if(/bobcmn/i.test(d))throw new AnyBalance.Error("МТС ввел защиту от автоматического входа. Пожалуйста, обратитесь в поддержку МТС, составьте обращение о невозможности использования третьесторонних программ слежения за балансом. Напомните им, что вы можете перейти к другому оператору, который не противодействует отслеживанию баланса.");
if(!d)throw new AnyBalance.Error("Личный кабинет МТС временно недоступен. Попробуйте ещё раз позже");if(/<h1[^>]*>\s*Request Error/i.test(d))throw new AnyBalance.Error("Личный кабинет МТС временно не работает. Попробуйте ещё раз позже");AnyBalance.trace(d);throw new AnyBalance.Error("Не удаётся найти форму входа! Сайт изменен?",f);}500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),d=AnyBalance.requestPost(b,e,addHeaders({Origin:g_baseurlLogin,
Referer:b})),fixCookies());if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",f);isOnLogin()&&(d=checkLoginError(d,a));if(isOnLogin())throw AnyBalance.trace(d),new AnyBalance.Error("Не удаётся зайти в личный кабинет. Он изменился или проблемы на сайте.",f);return d};
